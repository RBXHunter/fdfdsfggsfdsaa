local Players = game:GetService("Players")
local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local ROCKS = workspace:WaitForChild("Rocks")
local DISTANCE = 20
local espCache = {}
local running = true
local UPDATE_INTERVAL = 0.5

-- FUNCTIONS
local function removeESP(pebble)
	if espCache[pebble] then
		espCache[pebble]:Destroy()
		espCache[pebble] = nil
	end
end

local function ensurePart(pebble)
	local part = pebble:FindFirstChildWhichIsA("BasePart") or pebble:FindFirstChildWhichIsA("MeshPart")
	if not part then
		part = Instance.new("Part")
		part.Size = Vector3.new(1,1,1)
		part.Anchored = true
		part.CanCollide = false
		part.Transparency = 1
		part.Position = hrp.Position + Vector3.new(0,3,0)
		part.Parent = pebble
	end
	return part
end

local function getPebbleText(pebble)
	local counts = {}
	for _, ore in ipairs(pebble:GetChildren()) do
		if ore:IsA("Model") then
			local oreName = ore:GetAttribute("Ore")
			if oreName then
				counts[oreName] = (counts[oreName] or 0) + 1
			end
		end
	end

	local lines = {}
	for name, count in pairs(counts) do
		table.insert(lines, name .. " x" .. count)
	end

	if #lines == 0 then
		return nil
	end

	return table.concat(lines, "\n")
end

local function createESP(pebble)
	local text = getPebbleText(pebble)
	if not text then
		removeESP(pebble)
		return
	end

	local part = ensurePart(pebble)

	if espCache[pebble] then
		espCache[pebble].TextLabel.Text = text
		return
	end

	local gui = Instance.new("BillboardGui")
	gui.Name = "PebbleESP"
	gui.Adornee = part
	gui.Size = UDim2.new(0,180,0,50)
	gui.StudsOffset = Vector3.new(0,3,0)
	gui.AlwaysOnTop = true

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1,0,1,0)
	label.BackgroundTransparency = 1
	label.TextScaled = true
	label.Font = Enum.Font.SourceSansBold
	label.TextColor3 = Color3.fromRGB(255,200,100)
	label.TextStrokeTransparency = 0
	label.Text = text
	label.Parent = gui

	gui.Parent = part
	espCache[pebble] = gui
end

-- GUI с кастомной кнопкой Kill Script
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESPControlGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 150, 0, 60)
frame.Position = UDim2.new(0,20,0,20)
frame.BackgroundTransparency = 1
frame.BorderSizePixel = 0
frame.Parent = screenGui

-- Кастомная кнопка Kill Script
local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 130, 0, 40)
button.Position = UDim2.new(0,10,0,10)
button.Text = "kill Script"
button.Font = Enum.Font.PermanentMarker
button.TextColor3 = Color3.fromRGB(0,0,0)
button.TextSize = 30
button.TextStrokeColor3 = Color3.fromRGB(0,0,0)
button.TextStrokeTransparency = 0
button.BackgroundColor3 = Color3.fromRGB(255,255,255) -- фон под градиент
button.AutoButtonColor = true
button.Parent = frame

local uicorner = Instance.new("UICorner")
uicorner.CornerRadius = UDim.new(0,10)
uicorner.Parent = button

local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
	ColorSequenceKeypoint.new(0, Color3.fromRGB(255,0,0)),       -- красный
	ColorSequenceKeypoint.new(0.5, Color3.fromRGB(200,200,200)), -- центр серый
	ColorSequenceKeypoint.new(1, Color3.fromRGB(0,0,255))        -- синий
}
gradient.Rotation = 0
gradient.Parent = button

button.MouseButton1Click:Connect(function()
	running = false
	for pebble, gui in pairs(espCache) do
		gui:Destroy()
	end
	espCache = {}
	screenGui:Destroy()
end)

-- MAIN LOOP
spawn(function()
	while running do
		for _, island in ipairs(ROCKS:GetChildren()) do
			for _, obj in ipairs(island:GetDescendants()) do
				if obj:IsA("Model") then
					local hasOre = false
					for _, child in ipairs(obj:GetChildren()) do
						if child:IsA("Model") and child:GetAttribute("Ore") then
							hasOre = true
							break
						end
					end
					if hasOre then
						local posPart = obj:FindFirstChildWhichIsA("BasePart") or obj:FindFirstChildWhichIsA("MeshPart")
						local pos = posPart and posPart.Position or obj:GetModelCFrame().p
						if (hrp.Position - pos).Magnitude <= DISTANCE then
							createESP(obj)
						else
							removeESP(obj)
						end
					end
				end
			end
		end
		wait(UPDATE_INTERVAL)
	end
end)

-- Отслеживание новых моделей с Ore
for _, island in ipairs(ROCKS:GetChildren()) do
	island.DescendantAdded:Connect(function(child)
		if not running then return end
		if child:IsA("Model") and child:GetAttribute("Ore") then
			local parent = child.Parent
			if parent and parent:IsA("Model") then
				createESP(parent)
			end
		end
	end)
end
